#!/usr/bin/env ruby
# Copyright (C) Brian Candler 2009. Released under the Ruby licence.

# Turn on copy-on-write garbage collection in REE: see
# http://www.rubyenterpriseedition.com/documentation.html#_copy_on_write_friendliness

$LOG = File.open("/dev/null", "r")
$LOG.reopen(STDOUT)


begin
  GC.copy_on_write_friendly = true
rescue NoMethodError
end

$:.unshift File.expand_path(File.join(File.dirname(__FILE__), "..", "lib"))
require "snailgun/require_timings"
require 'snailgun/server'

conf = File.expand_path('config/boot.rb')
unless File.exist?(conf)
  raise "#{conf} does not exist, cannot continue"
end
sockdir = File.expand_path('tmp/sockets/snailgun')
begin
  Dir.mkdir sockdir, 0700
rescue Errno::EEXIST
  File.chmod 0700, sockdir
end
  
env = "test"

ENV['SNAILGUN'] = $$.to_s
    
STDERR.puts "Server starting for RAILS_ENV=#{env}"
server = Snailgun::Server.new("#{sockdir}/#{env}")
ENV['RAILS_ENV'] = env
load conf

if File.exist?('./.snailgun.preload')
  require 'snailgun/require_preload'
else
  puts "please create a .snailgun.preload ....."
end

if Rails.respond_to?(:configuration) && Rails.configuration.cache_classes
  STDERR.puts <<-EOS
WARNING: Snailgun doesn't work well with `cache_classes`. Strongly recommend
`config.cache_classes = false` in config/environments/#{env}.rb
EOS
end
STDERR.puts "Server ready for RAILS_ENV=#{env}"
server.run
